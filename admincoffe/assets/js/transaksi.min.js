let isCetak=!1,produk=[],transaksi=$("#transaksi").DataTable({responsive:!0,lengthChange:!1,searching:!1,scrollX:!0});function reloadTable(){transaksi.ajax.reload()}function nota(a){let t="",e="ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789",l=e.length;for(var r=0;r<a;r++)t+=e.charAt(Math.floor(Math.random()*l));return t}function getNama(){$.ajax({url:produkGetNamaUrl,type:"post",dataType:"json",data:{id:$("#barcode").val()},success:a=>{$("#nama_produk").html(a.nama_produk),$("#sisa").html(`Sisa ${a.stok}`),checkEmpty()},error:a=>{console.log(a)}})}function checkStok(){$.ajax({url:produkGetStokUrl,type:"post",dataType:"json",data:{id:$("#barcode").val()},success:a=>{let t=$("#barcode").val(),e=a.nama_produk,l=parseInt($("#jumlah").val()),r=parseInt(a.stok),s=parseInt(a.harga),o=a.barcode,n=parseInt($("#total").html());if(r<l)Swal.fire("Gagal","Stok Tidak Cukup","warning");else{let a=transaksi.rows().indexes().filter((a,t)=>o===transaksi.row(a).data()[0]);if(a.length>0){let e=transaksi.row(a[0]),o=e.data();r<o[3]+l?Swal.fire("stok","Stok Tidak Cukup","warning"):(o[3]=o[3]+l,e.data(o).draw(),indexProduk=produk.findIndex(a=>a.id==t),produk[indexProduk].stok=r-o[3],$("#total").html(n+s*l))}else produk.push({id:t,stok:r-l}),transaksi.row.add([o,e,s,l,`<button name="${t}" class="btn btn-sm btn-danger" onclick="remove('${t}')">Hapus</btn>`]).draw(),$("#total").html(n+s*l),$("#jumlah").val(""),$("#tambah").attr("disabled","disabled"),$("#bayar").removeAttr("disabled")}}})}function bayarCetak(){isCetak=!0}function bayar(){isCetak=!1}function checkEmpty(){let a=$("#barcode").val(),t=$("#jumlah").val();""!==a&&""!==t&&parseInt(t)>=1?$("#tambah").removeAttr("disabled"):$("#tambah").attr("disabled","disabled")}function checkUang(){let a=$('[name="jumlah_uang"').val(),t=parseInt($(".total_bayar").html());""!==a&&a>=t?($("#add").removeAttr("disabled"),$("#cetak").removeAttr("disabled")):($("#add").attr("disabled","disabled"),$("#cetak").attr("disabled","disabled"))}function remove(a){let t=transaksi.row($("[name="+a+"]").closest("tr")).data(),e=t[3],l=t[2],r=parseInt($("#total").html());akhir=r-e*l,$("#total").html(akhir),transaksi.row($("[name="+a+"]").closest("tr")).remove().draw(),$("#tambah").attr("disabled","disabled"),akhir<1&&$("#bayar").attr("disabled","disabled")}function add(){let a=transaksi.rows().data(),t=[];$.each(a,(a,e)=>{t.push(e[3])}),$.ajax({url:addUrl,type:"post",dataType:"json",data:{produk:JSON.stringify(produk),tanggal:$("#tanggal").val(),qty:t,total_bayar:$("#total").html(),jumlah_uang:$('[name="jumlah_uang"]').val(),diskon:$('[name="diskon"]').val(),pelanggan:$("#pelanggan").val(),nota:$("#nota").html()},success:a=>{isCetak?Swal.fire("Sukses","Sukses Membayar","success").then(()=>window.location.href=`<?php echo site_url('transaksi/cetak/') ?>${a}`):Swal.fire("Sukses","Sukses Membayar","success").then(()=>window.location.reload())},error:a=>{console.log(a)}})}function kembalian(){let a=$("#total").html(),t=$('[name="jumlah_uang"').val(),e=$('[name="diskon"]').val();$(".kembalian").html(t-a-e),checkUang()}$("#barcode").select2({placeholder:"Barcode",ajax:{url:getBarcodeUrl,type:"post",dataType:"json",data:a=>({barcode:a.term}),processResults:a=>({results:a}),cache:!0}}),$("#pelanggan").select2({placeholder:"Pelanggan",ajax:{url:pelangganSearchUrl,type:"post",dataType:"json",data:a=>({pelanggan:a.term}),processResults:a=>({results:a}),cache:!0}}),$("#tanggal").datetimepicker({format:"dd-mm-yyyy h:ii:ss"}),$(".modal").on("hidden.bs.modal",()=>{$("#form")[0].reset(),$("#form").validate().resetForm()}),$(".modal").on("show.bs.modal",()=>{let a=moment().format("D-MM-Y H:mm:ss"),t=$("#total").html(),e=$('[name="jumlah_uang"').val();$("#tanggal").val(a),$(".total_bayar").html(t),$(".kembalian").html(Math.max(e-t,0))}),$("#form").validate({errorElement:"span",errorPlacement:(a,t)=>{a.addClass("invalid-feedback"),t.closest(".form-group").append(a)},submitHandler:()=>{add()}}),$("#nota").html(nota(15));